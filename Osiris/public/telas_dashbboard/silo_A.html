<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silo A</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/style_dashboard.css">

</head>

<body onload="obterDadosGrafico()">

    <!-- Menu Lateral -->

    <div class="menu_lateral">
        <div class="container">
            <div class="perfil">
                <img src="../assets/img/perfil.png" id="logo_slogan_branco">

                <span id="nome">Nome do Usuário</span>
            </div>

            <ul class="links">
                <li>
                    <a href="../dashboard.html">Gerais</a>
                </li>
                <li>
                    <select onchange="window.location.href = this.value">
                        <option>Silos</option>
                        <option value="../telas_dashbboard/silo_A.html">Silo A</option>
                        <option value="../telas_dashbboard/silo_B.html">Silo B</option>
                    </select>
                </li>
            </ul>
            <a href="../index.html" class="botao_sair">Sair</a>
        </div>
    </div>

    <div class="titulo">
        <div class="container">
            <div style="text-align: center; margin: 20px 0;">
                <h2 style="font-weight: bold; color: #333;" id="h2Usuario">Olá usuário, você está vendo as métricas
                    gerais do silo A
                </h2>
            </div>
        </div>
    </div>

    <!-- KPIs -->

    <div class="kpis">
        <div class="container">

            <div class="card">
                <div class="info">
                    <span class="titulo">Percentual de gás metano atual</span>
                    <span class="dado" id="percentualAtual">0.80</span>
                </div>
            </div>

            <div class="card">
                <div class="info">
                    <span class="titulo">Percentual máximo de gás metano captado</span>
                    <span class="dado" id="percentualMax">1.20 | 01:00</span>
                </div>
            </div>

            <div class="card">
                <div class="info">
                    <span class="titulo">Percentual mínimo de gás metano captado</span>
                    <span class="dado" id="percentualMinimo">0.20 | 12:00</span>
                </div>
            </div>



        </div>
    </div>

    <!-- Gráficos -->

    <div class="graficos">
        <div class="container">
            <div class="card">
                <canvas id="grafico_barra"></canvas>
            </div>
            <div class="card">
                <canvas id="grafico_linha"></canvas>
            </div>
        </div>
    </div>


</body>

</html>

<script>
    const grafico1 = document.getElementById('grafico_barra');
    nome.innerHTML = sessionStorage.NOME_USUARIO;
    h2Usuario.innerHTML = `Olá ${sessionStorage.NOME_USUARIO}, você está vendo as métricas do silo A.`
    new Chart(grafico1, {
        type: 'line',
        data: {
            labels: [
                    '05/05', '06/05', '07/05', '08/05', '09/05', '10/05', '11/05', '12/05',
                    '13/05', '14/05', '15/05', '16/05', '17/05', '18/05', '19/05', '20/05',
                    '21/05', '22/05', '23/05', '24/05', '25/05', '26/05', '27/05', '28/05', 
                    '29/05', '30/05', '31/05', '01/06', '02/06', '03/06', '04/06', '05/06'
            ], datasets: [{
                label: 'Silo A',
                data: [
                    1.10, 1.20, 0.80, 0.50, 1.0, 1.10, 0.90, 0.30, 0.40, 0.80, 0.40, 0.30, 0.20, 0.60,
                    0.60, 1.00, 0.90, 0.70, 0.80, 1.10, 0.50, 0.60, 0.90, 0.40,
                    1.00, 0.80, 0.70, 0.60, 0.90, 0.50, 0.80, 1.10, 0.60, 0.40

                ], borderWidth: 1,
                backgroundColor: '#3f88c5',
                borderColor: '#3f88c5'
            },
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Percentual máximo captado por dia (nos ultimos 30 dias)',
                    color: '#222222',
                    font: {
                        size: 20,
                    }
                },
                tooltip: {
                    backgroundColor: '#333333',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff'
                }
            }
        }
    });


    // const grafico2 = document.getElementById('grafico_linha');

    // new Chart(grafico2, {
    //     type: 'line',
    //     data: {
    //         labels: [
    //             '00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00',
    //             '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00',
    //             '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
    //         ], datasets: [{
    //             label: 'Silo A',
    //             data: [
    //                 1.10, 1.20, 0.80, 0.50, 1.0, 1.10, 0.90, 0.30, 0.40, 0.80, 0.40, 0.30, 0.20, 0.60, 
    //             ], borderWidth: 1,
    //             backgroundColor: '#3f88c5',
    //             borderColor: '#3f88c5'
    //         },
    //         ]
    //     },
    //     options: {
    //         responsive: true,
    //         plugins: {
    //             legend: {
    //                 labels: {
    //                     font: {
    //                         size: 12
    //                     }
    //                 }
    //             },
    //             title: {
    //                 display: true,
    //                 text: 'Média diária dos gases no silo A (por Hora)',
    //                 color: '#222222',
    //                 font: {
    //                     size: 20,
    //                 }
    //             },
    //             tooltip: {
    //                 backgroundColor: '#333333',
    //                 titleColor: '#ffffff',
    //                 bodyColor: '#ffffff'
    //             }
    //         }
    //     }
    // });

    function obterDadosGrafico() {
        fetch(`/grafico/silosMedios`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log("deu true no gráfico 1")
                    // resposta.reverse();
                    plotarGraficoSilo(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function plotarGraficoSilo(resposta) {
        resposta.reverse();
        let labels = [];
        console.log('iniciando plotagem do gráfico...');
        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Silo A',
                data: [],
                fill: false,
                borderColor: '#3f88c5',
                backgroundColor: '#3f88c5',
                tension: 0.1,

            },
            ]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log("gráfico 1");
        console.log(resposta);
        // Inserindo valores recebidos em estrutura para plotar o gráfico
        var a = [];
        var b = []
        for (var i = 0; i < resposta.length; i++) {
            if (resposta[i].fk1 == 1) {
                dados.datasets[0].data.push(resposta[i].valor);
                labels.push(resposta[i].data_hora.substring(11, 19));
                a.push(resposta[i].valor);
                b.push(resposta[i].data_hora.substring(11, 19));
            }
        }
        percentualAtual.innerHTML = `${a[a.length - 1]} | ${b[b.length - 1]}`
        percentualMax.innerHTML = `${Math.max(...a)} | `;
        for (var i = 0; i < a.length; i++) {
            if (a[i] == Math.max(...a)) {
                break;
            }
        }
        percentualMax.innerHTML += `${b[i]}`;
        percentualMinimo.innerHTML = `${Math.min(...a)} | `
        for (var i = 0; i < a.length; i++) {
            if (a[i] == Math.max(...a)) {
                break;
            }
        }
        percentualMinimo.innerHTML += `${b[i]}`
        // Inserindo valores recebidos em estrutura para plotar o gráfico
        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela

        let chartClass = new Chart(
            document.getElementById(`grafico_linha`),
            config,
        )
        setTimeout(() => atualizarGrafico(dados, chartClass), 6000);
    };


    function atualizarGrafico(dados, chartClass) {
        fetch(`/grafico/silosAtualizar/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // obterdados(idAquario);
                    // alertar(novoRegistro, idAquario);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    // let avisoCaptura = document.getElementById(`avisoCaptura${idAquario}`)
                    // avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].data_hora == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].data_hora.substring(11, 19))
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].data_hora.substring(11, 19)); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].valor); // incluir uma nova medida de umidade

                        chartClass.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, chartClass), 6000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, chartClass), 6000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>